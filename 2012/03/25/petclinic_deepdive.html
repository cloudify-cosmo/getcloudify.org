<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>	
    <title>Cloudify - Mongo DB Sharding in the Pet Clinic Application recipe</title>
    <link rel="stylesheet" href="/css/template.css" type="text/css"/>    
	<link rel="canonical" href="http://www.cloudifysource.org/2012/03/25/petclinic_deepdive.html"/>	
    <link rel="stylesheet" href="/css/jquery-ui-1.8.17.custom.css" type="text/css" media="all"/>
    <link rel="stylesheet" type="text/css" href="/scripts/prettify/prettify.css">	
	<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <script type="text/javascript" src="/scripts/jquery-1.6.4.js"></script>
    <script type="text/javascript" src="/scripts/search.js"></script>
    <script type="text/javascript" src="/scripts/jquery-ui-1.8.17.custom.min.js"></script>
    <script type="text/javascript" src="/scripts/jquery.prettyPhoto.js"></script>
	<script type="text/javascript" src="/scripts/prettify/prettify.js"></script>
    <script type="text/javascript">
    window.onload = function () {
	$('body').addClass("bodyClass");
 	}
             $(function(){ 
             	$("a.youtube").YouTubePopup({ hideTitleBar: true });
           	$("div.expand").hide();
           	$("li.expandBtn").click(function(){	
    		  $(this).next("div.expand").slideToggle(500);
    		  if($(this).html()=="More..."){
    		  	$(this).html("Less...");	
    		  }else{
    		  	$(this).html("More...");
    		  }
    		  
			});
           /* ------------- added by Yaron ------------ */
			$("span.pln, span.kwd").css("cursor","pointer");
			$("span.pln, span.kwd").hover(function(){$(this).css("background-color","#CECECE");},function(){$(this).css("background-color","transparent");});
	        $("span.pln, span.kwd").click( function(eventObject) {
				var currKey = $(eventObject.currentTarget).text().trim();
				if (currKey == "name") {
					var prevKey = $(eventObject.currentTarget).prev().prev("span.pln").text().trim();
					currKey = prevKey + "_" + currKey;
					
				}
				var tooltip = $(".overlay");
				var position = $(eventObject.currentTarget).offset();				
				$("#desc",tooltip).text(messages[currKey]);		
				tooltip.show().offset({ top: position.top + tooltip.scrollTop() - 75, left: position.left + 100});
				$("#tipImg").position()
				$("#closeBut").click(function() {$(".overlay").offset({top:0,left:0}).hide();})
			 });
			 
			 
			 
 
          
          
           
			 
			 
			 
           }
           
           
          
  
           
           
           
           
	 );
    
    </script>
    
    <script type="text/javascript" src="/scripts/cloudify_default.js"></script>



    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-29063606-1']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
        

    </script>
    
 

</head>
<body>
<div class="WrapperBg">
    <a class="fork-guide" target="_blank" href="https://github.com/CloudifySource/cloudify"></a>	
    <div class="Wrapper">
        <div class="header">
    <a class="logo" href="/"></a>
    <div class="clear"></div>
            <div class="topMenu">
                <ul class="_topmenu">
                    <li class="topmenuli"><a class="bgMenu1" href="http://forums.cloudifysource.org/forums"><span class="title1">Discuss & Suggest</span><span class="title2">Support Forums</span></a></li>
                    <li class="sep"></li>
                    <li class="topmenuli"><a class="bgMenu2" href="/guide/qsg/quick_start_guide"><span class="title1">Learn</span><span class="title2">Knowledge Base</span></a></li>
                    <li class="sep"></li>
                    <li class="topmenuli"><a class="bgMenu3" href="/participate"><span class="title1">Participate</span><span class="title2">Events & Webinars</span></a></li>
                    <li class="sep"></li>
                    <li class="topmenuli"><a class="bgMenu4" href="/blog"><span class="title1">Read</span><span class="title2">Blog Posts & Updates</span></a></li>
                    <li class="sep"></li>
                    <li class="topmenuli"><a class="bgMenu5" href="/cloudifysourcetv"><span class="title1">Watch</span><span class="title2">Watch & Learn</span></a></li>
                    <li class="sep"></li>
                    <li class="topmenuli"><a class="bgMenu6" href="/guide/contribute/how_to"><span class="title1">Develop</span><span class="title2">Get Involved</span></a></li>

		</ul>
		<div class="clear"></div>
	</div>
</div>

<!-- Tooltip Container -->
<div class="overlay">
<div class="overlayFrame">
<div style="width:100%;height:25px;align:left;"><img src="/images/close.png" id="closeBut"/></div>
<div><span id="desc"></span><br/>
 <span id="required"></span><br/>
 <span id="values"></span>
 </div>
</div>
<img src="/images/box_edge.png" id="tipImg"/>  
</div>
        <div class="contentWrap">            
			<div class="breadcrumbs">Home Page > Cloudify Blogs > Mongo DB Sharding in the Pet Clinic Application recipe</div>
            <div class="clear"></div>

            <!--Search-->
			
            
 

<div class="learnFrom">
    <h2>Blog Posts and Updates</h2>

    <div class="searchWrap">
        <form id="searchForm" action="#" method="get">
            <input id="search" class="searchTxt" type="text" placeholder="Search..."/>
            <input id="goBtn" class="searchBtn" type="submit" value="Go"/>
        </form>
    </div>
</div>





            <div class="content">
                <div class="left">
                    <a class="btnGetCloudifyFreeEdition" target="_blank" href="/downloads/get_cloudify"></a>
                    <!--Event groups-->



<div class="leftContentBox blogLeft-topTitle">
	<h3>Recent Posts</h3>
</div>


<div class="leftContentBox blogLeftBox"> 
   
	<a href="/2012/05/09/how_we_built_it.html">How We Built This site 
	 <img class="noMargin" src="/images/arrow-right-blue.png" /></a><br />
	<span class="date">May  9, 2012</span>  
	<br/><br/>
  
	<a href="/2012/05/03/mapping-the-cloudpaas-stack.html">Mapping the Cloud/PaaS Stack 
	 <img class="noMargin" src="/images/arrow-right-blue.png" /></a><br />
	<span class="date">May  3, 2012</span>  
	<br/><br/>
  
	<a href="/2012/05/01/whats_new_in_cloudify_2_1.html">What's new in Cloudify 2.1 
	 <img class="noMargin" src="/images/arrow-right-blue.png" /></a><br />
	<span class="date">May  1, 2012</span>  
	<br/><br/>
		
</div>

<div class="leftContentBox blogLeft-topTitle">
	<h3>Archived Posts</h3>
</div>

 <ul class="blog-archive-list">
 
 
	
	
	
	
	
	

	
<li><a href="/2012/05">May 2012</a> <span class="blue">(3)</span></li>

	

	
		
			
		
	

	
	
	
	
	
	

	

	
		
			
		
	

	
	
	
	
	
	

	

	
		
			
<li><a href="/2012/03">March 2012</a> <span class="blue">(3)</span></li>

			
		
	

	
	
	
	
	
	

	

	
		
			
		
	

	
	
	
	
	
	

	

	
		
			
		
	

	
	
	
	
	
	

	

	
		
			
<li><a href="/2012/02">February 2012</a> <span class="blue">(1)</span></li>

			
		
	

	
	
	
	
	
	

	

	
		
			
<li><a href="/2012/01">January 2012</a> <span class="blue">(2)</span></li>

			
		
	

	
	
	
	
	
	

	

	
		
			
		
	

	
	
	
	
	
	

	

	
		

<li><a href="/2011/11">November 2011</a> <span class="blue">(1)</span></li>

		
	

	
	
	
	
	
	

	

	
		
			
<li><a href="/2011/10">October 2011</a> <span class="blue">(1)</span></li>

			
		
	

	
	
	
	
	
	

	

	
		
			
<li><a href="/2011/09">September 2011</a> <span class="blue">(1)</span></li>

			
		
	

	
	
	
	
	
	

	

	

	





 
 </ul>

                </div>

                <!--Start left content -->

                <div id="resultsDiv" class="DocumentsWrap"></div>
                <div id="pageContent" class="DocumentsWrapRight">
                    <h1 class="pageTitle">Mongo DB Sharding in the Pet Clinic Application recipe</h1>
					 
					  <span class="blogPostInfo">Posted By: <a href="#">Tamir Korem</a>  on March 25, 2012  
					  </span>
					  <br/><br/><br/>
					 
                    <h2>Can you shard on a cloud platform in a galaxy far far away ?</h2>
<p>In general, managing a <a href="http://www.mongodb.org/display/DOCS/Sharding+Introduction">sharded Mongo</a> setup is not an easy task but it&#8217;s much more difficult to do it on any cloud.<br />
When you deploy a sharded Mongo on a cloud (any cloud&#8230;), you have quite a few barriers that you need to overcome :</p>
<ul>
	<li>How to ensure that the Mongo Routing Server finds the location of the shards</li>
	<li>Does this router know where the Mongo Config Server resides ?</li>
	<li>How can you verify that your sharding actually works?</li>
	<li>Will you be able to monitor your application&#8217;s performance?</li>
	<li>Can you scale out or in ?</li>
</ul>
<p><br/>
Cloudify enables you to achieve all of the above and more.<br />
So, in order to understand how to get this done, I will give you a more thorough walk-through into the MongoDB recipe in the Pet Clinic Application recipe that we described in the <a href="/guide/qsg/quick_start_guide">Quick Start Guide</a>.</p>
<h2>What is Database Sharding?</h2>
<p>Database sharding can be simply defined as a <a href="http://en.wikipedia.org/wiki/Shared_nothing_architecture">shared-nothing</a> partitioning scheme for large databases across a number of servers, making new levels of database performance and scalability achievable.<br />
Another way of &#8220;looking&#8221; at it, is : <br />
Breaking your database down into smaller chunks called &#8220;shards&#8221; and spreading those shards across a number of distributed servers.</p>
<h2>MongoDB Sharding</h2>
<p>MongoDB supports an automated sharding/partitioning architecture, enabling horizontal scaling across multiple nodes.</p>
<p>A MongoDB shard cluster consists of two or more shards, one or more configuration servers, and any number of routing processes to which the application servers connect.</p>
<p>Each shard consists of one or more servers and stores data using MongoD processes (MongoD is the core MongoDB database process).<br />
In a production environment, each shard will consist of multiple servers to ensure availability and automated failover.</p>
<h2>About the Pet Clinic Application</h2>
<p>The Pet Clinic Application presented in the Quick Start Guide is a port to Grails of the standard <a href="http://static.springsource.org/docs/petclinic.html">Java based Spring framework PetClinic sample app</a>.<br />
It uses MongoDB instead of MySQL as the backend store, and leverages the Grails <span class="caps">GORM</span> bindings to MongoDB. The users of the application are employees of the clinic who need to view and manage information regarding veterinarians, pet owners, and their pets.<br />
The application&#8217;s production environment is based on a two-tier architecture:</p>
<ol>
	<li>Web and Business Logic Tier &#8211; Comprised of the Grails application deployed on Apache Tomcat.</li>
	<li>The Data Tier &#8211; Comprised of <a href="http://www.mongodb.org/display/DOCS/Sharding+Introduction" title="Sharded MongoDB">a sharded MongoDB cluster</a>, which is comprised itself of the following components:
	<ol>
		<li><a href="http://www.mongodb.org/display/DOCS/Configuring+Sharding#ConfiguringSharding-ConfigServers" title="MongoDB Configuration Server">Configuration Server</a> : Stores the cluster&#8217;s metadata, which includes basic information on each shard server and the chunks contained therein.</li>
		<li>Routing Processes (MongoS): A routing and coordination process that mediates between client requests and the actual mongod instances.  When receiving client requests, the MongoS process routes the request to the appropriate MongoD instance(s) and merges any results sent back to the client.</li>
		<li>MongoD instances (<span class="caps">AKA</span> shards): In our case, there are two instances of MongoD to store the application data.</li>
	</ol></li>
</ol>
<p>Obviously, the amount of instances for each of the above components can easily be changed, by modifying the numInstances attribute of the relevant Cloudify recipe file (i.e: &lt;service-name&gt;-service.groovy).</p>
<p><strong>Note</strong>: When you install MongoDB on Windows 7, you need to make sure that you login as an administrator. See <a href="http://www.mongodb.org/display/DOCS/Windows+Service">Installing MongoDB on Windows 7</a>.</p>
<h2>Our Pet Clinic Topology</h2>
<p>As mentioned above, in our recipe we&#8217;re going to use: two shards (MongoD), one configuration server (MongoConfig), one routing server (MongoS) and one Tomcat.<br />
This is our Pet Clinic Application&#8217;s Topology:</p>
<p><img src="/guide/images/overview/petClinicSharding.jpg" /></p>
<h2>Our Pet Clinic Recipe Anatomy</h2>
<p>The following diagram depicts the application recipe file and folder structure:</p>
<p><img src="/guide/images/setup/pet_clinic_anatomy3.JPG" /></p>
<h2>Mongo services in the Pet Clinic Recipe</h2>
<p>Let&#8217;s take a closer look at the Mongo entities in the PetClinic application recipe.</p>
<ol>
	<li>The Shards (mongod) recipe folder</li>
	<li>The Configuration Server (mongoConfig) recipe folder</li>
	<li>The Routing Processes (mongos) recipe folder</li>
</ol>
<p>In each of the above folders you will find all the files required to run the corresponding service. <br />
A &#8220;service&#8221; in this context is an application tier &#8211; e.g. web container, database, etc.</p>
<h2>The Mongo Data Shards (mongod) Recipe</h2>
<p>The Mongo Data Shards (mongod) Recipe does the following:</p>
<ul>
	<li>Calculates its port according to its instance ID and properties file and notifies the serviceContext, so that the other services will be able to access it.</li>
	<li>Downloads, unzips and installs the Mongo binaries on the VM</li>
	<li>Starts the Shard Server process.</li>
	<li>Detects a successful startup using the MongoLivenessDetector plugin</li>
	<li>Looks for metrics (Active Read Clients, Active Write Client etc.) to be displayed in the Web UI.</li>
</ul>
<p>The mongod service file is located at &lt;cloudify root&gt;/recipes/apps/petclinic/mongod/mongod-service.groovy.</p>
<p>The following is the installation event handler of the mongod service:<br />
<script src="https://gist.github.com/1999961.js?file=mongod_install.groovy"></script></p>
<p>And here&#8217;s the start event handler of the mongod service:<br />
<script src="https://gist.github.com/2000070.js?file=mongod_start.groovy"></script></p>
<h2>The Mongo Config Server (mongoConfig) Service Recipe</h2>
<p>The Mongo Config Server (mongoConfig) Server recipe does the following:</p>
<ul>
	<li>Calculates its port according to its instance ID and properties file and notifies the serviceContext, so that the other services will be able to access it.</li>
	<li>Downloads, unzips and installs the Mongo binaries on the VM.</li>
	<li>Starts the Configuration Server process.</li>
	<li>Detects a successful startup using the MongoLivenessDetector plugin.</li>
	<li>Looks for metrics (Active Read Clients, Active Write Client etc.) to be displayed in the Web UI.</li>
</ul>
<p>The mongo-config service file is located at &lt;cloudify root&gt;/recipes/apps/petclinic/mongoConfig/mongoConfig-service.groovy.</p>
<p>The installation event handler of the mongoConfig service is similar to the mongod service.<br />
Here&#8217;s the start event handler of the mongoConfig service:<br />
<script src="https://gist.github.com/2001221.js?file=mongoConfig_start.groovy"></script></p>
<h2>The Mongo Sharding Server (mongos) Recipe</h2>
<p>The Mongo Router (mongos) recipe does the following:</p>
<ul>
	<li>Calculates its port according to its instance ID and properties file and notifies the serviceContext, so that the other services will be able to access it.</li>
	<li>Downloads, unzips and installs the Mongo binaries on the VM.</li>
	<li>Starts the Router Server process.</li>
	<li>Detects a successful startup using the MongoLivenessDetector plugin.</li>
	<li>Looks for host address and port of the mongoConfig service (using the serviceContext <span class="caps">API</span>) and the Mongo data shards (mongod), and configures sharding.</li>
	<li>Looks for metrics (Active Read Clients, Active Write Client etc.) to be displayed in the Web UI.</li>
</ul>
<p>The mongos service file is located at &lt;cloudify root&gt;/recipes/apps/petclinic/mongos/mongos-service.groovy.</p>
<p>The installation event handler of the mongos service is similar to the mongod service.<br />
Here&#8217;s the start event handler of the mongos service:<br />
<script src="https://gist.github.com/2012345.js?file=mongos_start.groovy"></script></p>
<p>And here&#8217;s the post start event handler of the mongos service:<br />
<script src="https://gist.github.com/2015626.js?file=mongos_postStart.groovy"></script></p>
<p>Now, the tomcat service can retrieve the data in &lt;cloudify root&gt;/recipes/apps/petclinic/tomcat/tomcat_start.groovy</p>
<script src="https://gist.github.com/1698923.js?file=retrieveMongosServie.groovy"></script><p>From this point, the tomcat service instance knows the host address and port of the mongos service instance.</p>
<p>As you can see, by using Cloudify, you are now able to quickly shard and manage MongoDB on the cloud of your choice.</p>
<p>For more information on Mongo sharding with Cloudify visit <a href="http://www.cloudifysource.org/cloudifysourcetv">Cloudify In Action</a> online demo.<br />
We also recommend that you register to the <a href="http://www.cloudifysource.org/participate">Manage your Sharded MongoDB Setup</a> webinar which will be held on April 24th, 2012.</p>
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'cloudifysource'; // required: replace example with your forum shortname
    var disqus_identifier = '/2012/03/25/petclinic_deepdive.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>

                <div class="clear"></div>
            </div>
        </div>

        <!--Start pagination -->

        <div class="clear"></div>

        <!--Start Footer -->

        <div class="footer">
    <!--<ul class="footerLeftMenu">
        <li class="footerli"><a href="#">About GigaSpaces</a></li>
        <li class="footerli"><a href="#">Contact Us</a></li>
    </ul> -->
    <ul class="footerRightMenu">
        <li class="footerli">Copyright Â© 2012 GigaSpaces. All rights reserved.</li>
        <li class="footerli"><a href="/about_us">About Us</a></li>
        <li class="footerli">|</li>
        <li class="footerli"><a href="/terms_of_use">Terms of Use</a></li>
        <li class="footerli">|</li>
        <li class="footerli"> <a href="/privacy_policy">Privacy Policy</a></li>
    </ul> 
    <ul class="footerSocialMenu">
        <li class="footerFb"><a href="https://www.facebook.com/GigaSpaces?sk=app_201742856511228"></a></li>
        <li class="footerRss"><a href="/atom.xml"></a></li>
        <!--<li class="footerMell"><a href="#"></a></li>-->
        <li class="footerTwitt"><a href="http://www.twitter.com/cloudifysource"></a></li>
        <li class="footerYt"><a href="http://www.youtube.com/cloudifysource"></a></li>
    </ul>
</div>


    </div>
    <!--End site wrapper -->


</div>
<!--End site bg top wrapper -->
</body>
</html>
